###############################################################################
# ChatSDK INSTANT Docker Compose
# All-inclusive development environment - Zero external dependencies
#
# Includes: PostgreSQL, MinIO (S3), Centrifugo, API Server, Demo UI
# Usage: docker compose -f docker-compose.instant.yml up -d
###############################################################################

version: '3.8'

services:
  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: chatsdk-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: chatsdk
      POSTGRES_PASSWORD: ${DB_PASSWORD:-chatsdk-dev-password}
      POSTGRES_DB: chatsdk
    ports:
      - "5434:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../packages/api/src/db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatsdk"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - chatsdk

  # ==========================================================================
  # MinIO (S3-Compatible Storage)
  # ==========================================================================
  minio:
    image: minio/minio:latest
    container_name: chatsdk-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: chatsdk
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET:-chatsdk-minio-secret}
    ports:
      - "9004:9000"   # S3 API
      - "9006:9001"   # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - chatsdk

  # MinIO bucket setup (runs once)
  minio-setup:
    image: minio/mc:latest
    container_name: chatsdk-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 chatsdk ${MINIO_SECRET:-chatsdk-minio-secret};
      mc mb local/chatsdk --ignore-existing;
      mc anonymous set download local/chatsdk;
      exit 0;
      "
    networks:
      - chatsdk

  # ==========================================================================
  # Centrifugo (Real-time WebSocket Server)
  # ==========================================================================
  centrifugo:
    image: centrifugo/centrifugo:v5
    container_name: chatsdk-centrifugo
    restart: unless-stopped
    command: centrifugo --config=/centrifugo/config.json
    volumes:
      - ./centrifugo.instant.json:/centrifugo/config.json:ro
    ports:
      - "8001:8000"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/health"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - chatsdk

  # ==========================================================================
  # ChatSDK API Server
  # ==========================================================================
  api:
    build:
      context: ../
      dockerfile: docker/Dockerfile.api
    container_name: chatsdk-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      centrifugo:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    environment:
      NODE_ENV: production
      PORT: 5500
      LOG_LEVEL: info

      # CORS - Allow demo UI and common dev ports
      ALLOWED_ORIGINS: http://localhost:5501,http://localhost:5500,http://localhost:3000,http://localhost:5173

      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: chatsdk
      DB_USER: chatsdk
      DB_PASSWORD: ${DB_PASSWORD:-chatsdk-dev-password}
      DB_SSL: "false"

      # Authentication
      ADMIN_API_KEY: ${ADMIN_API_KEY:-chatsdk-admin-key}
      JWT_SECRET: ${JWT_SECRET:-chatsdk-jwt-secret-change-in-production}

      # Centrifugo
      CENTRIFUGO_URL: ws://centrifugo:8000/connection/websocket
      CENTRIFUGO_API_URL: http://centrifugo:8000/api
      CENTRIFUGO_API_KEY: ${CENTRIFUGO_SECRET:-chatsdk-centrifugo-secret}
      CENTRIFUGO_TOKEN_SECRET: ${CENTRIFUGO_SECRET:-chatsdk-centrifugo-secret}

      # S3 Storage (MinIO)
      S3_ENDPOINT: http://minio:9000
      S3_REGION: us-east-1
      S3_ACCESS_KEY: chatsdk
      S3_SECRET_KEY: ${MINIO_SECRET:-chatsdk-minio-secret}
      S3_BUCKET: chatsdk
      S3_PUBLIC_URL: http://localhost:9004/chatsdk
    ports:
      - "5500:5500"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5500/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - chatsdk

  # ==========================================================================
  # Demo Chat UI (React)
  # ==========================================================================
  demo-ui:
    build:
      context: ../examples/react-chat-huly
      dockerfile: ../../docker/Dockerfile.demo-ui
    container_name: chatsdk-demo-ui
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      VITE_API_URL: http://localhost:5500
      VITE_WS_URL: ws://localhost:8001/connection/websocket
      VITE_APP_API_KEY: ${APP_API_KEY:-demo-api-key}
    ports:
      - "5501:80"
    networks:
      - chatsdk

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  postgres_data:
    name: chatsdk-postgres-data
  minio_data:
    name: chatsdk-minio-data

# ==========================================================================
# Networks
# ==========================================================================
networks:
  chatsdk:
    name: chatsdk-network
    driver: bridge
