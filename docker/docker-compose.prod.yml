version: '3.8'

services:
  # API Server (production mode)
  api:
    # Use published image (recommended)
    image: ghcr.io/impact-idol/chatsdk/api:latest
    # Or build from source (for custom modifications):
    # build:
    #   context: ../
    #   dockerfile: docker/Dockerfile.api
    #   target: production
    ports:
      - "${API_PORT:-5500}:5500"
    environment:
      NODE_ENV: production
      PORT: 5500

      # Database Configuration (use managed PostgreSQL in production)
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_SSL: ${DB_SSL:-true}

      # S3-Compatible Storage (AWS S3, DigitalOcean Spaces, Cloudflare R2, etc.)
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET}
      S3_PUBLIC_URL: ${S3_PUBLIC_URL}  # CDN URL if applicable

      # Centrifugo Configuration (use managed or dedicated instance)
      CENTRIFUGO_URL: ${CENTRIFUGO_URL:-ws://centrifugo:8000/connection/websocket}
      CENTRIFUGO_API_URL: ${CENTRIFUGO_API_URL:-http://centrifugo:8000/api}
      CENTRIFUGO_API_KEY: ${CENTRIFUGO_API_KEY}
      CENTRIFUGO_TOKEN_SECRET: ${CENTRIFUGO_TOKEN_SECRET}

      # Inngest Configuration
      INNGEST_EVENT_KEY: ${INNGEST_EVENT_KEY}
      INNGEST_SIGNING_KEY: ${INNGEST_SIGNING_KEY}

      # Redis Configuration (use managed Redis in production)
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_TLS: ${REDIS_TLS:-true}

      # JWT Secrets
      JWT_SECRET: ${JWT_SECRET}
      CENTRIFUGO_JWT_SECRET: ${CENTRIFUGO_JWT_SECRET}

      # Optional: OpenAI for AI features
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - chatsdk-network

  # Centrifugo (real-time WebSocket server)
  centrifugo:
    image: centrifugo/centrifugo:v5
    ports:
      - "${CENTRIFUGO_PORT:-8000}:8000"
    environment:
      CENTRIFUGO_TOKEN_HMAC_SECRET_KEY: ${CENTRIFUGO_TOKEN_SECRET}
      CENTRIFUGO_API_KEY: ${CENTRIFUGO_API_KEY}
      CENTRIFUGO_ADMIN_PASSWORD: ${CENTRIFUGO_ADMIN_PASSWORD}
      CENTRIFUGO_ADMIN_SECRET: ${CENTRIFUGO_ADMIN_SECRET}
      CENTRIFUGO_LOG_LEVEL: ${CENTRIFUGO_LOG_LEVEL:-info}
    volumes:
      - ./centrifugo.json:/centrifugo/config.json
    command: centrifugo --config=/centrifugo/config.json
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - chatsdk-network

  # Reverse Proxy (optional - can use external load balancer)
  nginx:
    image: nginx:alpine
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro  # SSL certificates
    depends_on:
      - api
      - centrifugo
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - chatsdk-network

networks:
  chatsdk-network:
    driver: bridge

# Note: In production, use external managed services for:
# - PostgreSQL (AWS RDS, DigitalOcean Managed Databases, etc.)
# - S3 Storage (AWS S3, DigitalOcean Spaces, Cloudflare R2, etc.)
# - Redis (AWS ElastiCache, Redis Cloud, etc.)
# - Optionally: Centrifugo as a managed service or dedicated instance

# Secrets Management:
# - Use Docker secrets for sensitive data
# - Or use environment variable injection from CI/CD
# - Or use external secret managers (AWS Secrets Manager, HashiCorp Vault, etc.)
